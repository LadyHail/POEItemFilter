@model POEItemFilter.ViewModels.ItemUserList

@{
    ViewBag.Title = "Create new item filter";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="row">

    <div id="newFilter" style="float:left">
        <h2>Create new item filter</h2>

        <p>
            <textarea id="filterName" class="my-textarea">Enter filter name</textarea>
        </p>

        <p>
            <textarea id="description" class="my-textarea">Let people know more about Your filter! 
What kind of items are You looking for? Currency? Unique? 
Maybe it's used by specific class?</textarea>
        </p>

        <p>
            <a href="~/UsersItems/NewItem" id="newItem" class="btn btn-primary">New Item <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></a>
            <a href="#" id="createFilter" class="btn btn-primary">Generate filter <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></a>
        </p>
    </div>

    @if (Model != null)
    {
        <div id="itemsList" style="float:left">
            <table class="table">
                <tr>
                    <th>Items list</th>
                </tr>
                @foreach (var item in Model.UsersItems)
                {
                    <tr>
                        <td>@item.ToString()</td>
                    </tr>
                }
            </table>
        </div>
    }
</div>

@section scripts
{
    <script>
        $(document).ready(function () {
            $("#filterName").css({ "height": 28 });
            $("#description").css({ "height": 112 });
            $(".btn").hide();
            $("#newFilter").hide().slideDown(500, function () {
                $(".btn").fadeIn(1000);
            });

            $("#filterName").click(function () {
                $(this).val() !== "" && $(this).val() !== $(this).prop("defaultValue") ? "" : $(this).val(null);
            });

            $("#description").click(function () {
                $(this).val() !== "" && $(this).val() !== $(this).prop("defaultValue") ? "" : $(this).val(null);
            });

            $("#createFilter").click(function () {
                const filterName = $("#filterName").val();
                if (filterName === "" || filterName === "Enter filter name") {
                    alert("Filter name can't be empty!");
                } else if ($("#itemsList").length === 0) {
                    alert("Can't create empty filter! Add items!")
                } else {
                    $.ajax({
                        type: "POST",
                        url: "@Url.Action("SaveFilter", "Filters")",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify({ "filterName": $("#filterName").val(), "description": $("#description").val() }),
                        success: function (data) {
                            if (data.fileName != "") {
                                window.location.href = "@Url.RouteUrl(new { Controller = "Filters", Action = "Download"})/?file=" + data.fileName;
                                ClearSession();
                                alert("Well done!");
                            };
                        },
                        error: function (data, status, error) {
                            alert("Oops... Something went wrong!");
                        },
                    });
                }
            });

            function ClearSession() {
                $("#filterName").val($("#filterName").prop("defaultValue"));
                $("#description").val($("#description").prop("defaultValue"));
                $("#itemsList").remove();
                $.post("/Filters/ClearSession", function () {
                });
            };
    });
    </script>
    }